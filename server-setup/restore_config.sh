#!/bin/bash

# üîÑ –°–ö–†–ò–ü–¢ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ô –ò–ó –ë–≠–ö–ê–ü–ê
# –í–µ—Ä—Å–∏—è: Final
# –û–ø–∏—Å–∞–Ω–∏–µ: –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∏–∑ –∞—Ä—Ö–∏–≤–æ–≤

# ========================================
# –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
# ========================================
BACKUP_DIR="/root/backups"
PROJECT_DIR="/home/deployer/voice-ai-assistant"

# ========================================
# –§–£–ù–ö–¶–ò–ò
# ========================================

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±—ç–∫–∞–ø–æ–≤
show_available_backups() {
  echo "üì¶ –î–û–°–¢–£–ü–ù–´–ï –ë–≠–ö–ê–ü–´:"
  echo "==================="
  
  if [ ! -d "$BACKUP_DIR" ] || [ -z "$(ls -A "$BACKUP_DIR"/config_backup_*.tar.gz 2>/dev/null)" ]; then
    echo "‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±—ç–∫–∞–ø–æ–≤ –≤ $BACKUP_DIR"
    return 1
  fi
  
  ls -lht "$BACKUP_DIR"/config_backup_*.tar.gz | while read line; do
    filename=$(echo "$line" | awk '{print $9}')
    size=$(echo "$line" | awk '{print $5}')
    date=$(echo "$line" | awk '{print $6, $7, $8}')
    basename_file=$(basename "$filename")
    echo "üìÑ $basename_file ($size) - $date"
  done
  
  echo "==================="
  return 0
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –±—ç–∫–∞–ø–∞
select_backup() {
  while true; do
    echo ""
    echo "üéØ –í—ã–±–µ—Ä–∏—Ç–µ –±—ç–∫–∞–ø –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:"
    echo "   1) –í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: config_backup_20250725_155323.tar.gz)"
    echo "   2) –í–≤–µ–¥–∏—Ç–µ 'latest' –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –±—ç–∫–∞–ø–∞"
    echo "   3) –í–≤–µ–¥–∏—Ç–µ 'exit' –¥–ª—è –≤—ã—Ö–æ–¥–∞"
    echo ""
    read -p "–í–∞—à –≤—ã–±–æ—Ä: " BACKUP_CHOICE
    
    case "$BACKUP_CHOICE" in
      "exit"|"quit"|"q")
        echo "üëã –í—ã—Ö–æ–¥ –∏–∑ –ø—Ä–æ–≥—Ä–∞–º–º—ã"
        exit 0
        ;;
      "latest"|"last")
        BACKUP_FILE=$(ls -t "$BACKUP_DIR"/config_backup_*.tar.gz 2>/dev/null | head -1)
        ;;
      *.tar.gz)
        BACKUP_FILE="$BACKUP_DIR/$BACKUP_CHOICE"
        ;;
      *)
        echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑."
        continue
        ;;
    esac
    
    if [ -f "$BACKUP_FILE" ]; then
      echo "‚úÖ –í—ã–±—Ä–∞–Ω –±—ç–∫–∞–ø: $(basename "$BACKUP_FILE")"
      return 0
    else
      echo "‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: $BACKUP_CHOICE"
      echo "üîç –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –±—ç–∫–∞–ø–æ–≤ –≤—ã—à–µ"
    fi
  done
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
preview_backup() {
  echo ""
  echo "üìã –°–û–î–ï–†–ñ–ò–ú–û–ï –í–´–ë–†–ê–ù–ù–û–ì–û –ë–≠–ö–ê–ü–ê:"
  echo "================================"
  tar -tzf "$BACKUP_FILE" | while read file; do
    if [ -f "/$file" ]; then
      echo "‚úÖ /$file (—Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω)"
    else
      echo "‚ûï /$file (–±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω)"
    fi
  done
  echo "================================"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
confirm_restore() {
  echo ""
  echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï! –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã!"
  echo ""
  read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ? (yes/no): " CONFIRM
  
  case "$CONFIRM" in
    yes|YES|y|Y|–¥–∞|–î–ê)
      return 0
      ;;
    *)
      echo "‚ùå –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ"
      exit 0
      ;;
  esac
}

# ========================================
# –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê
# ========================================

echo "üîÑ –°–ö–†–ò–ü–¢ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò"
echo "====================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
if [ "$EUID" -ne 0 ]; then
  echo "‚ùå –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –æ—Ç –∏–º–µ–Ω–∏ root: sudo $0"
  exit 1
fi

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –±—ç–∫–∞–ø—ã
if ! show_available_backups; then
  exit 1
fi

# –í—ã–±–∏—Ä–∞–µ–º –±—ç–∫–∞–ø
select_backup

# –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä
preview_backup

# –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
confirm_restore

# ========================================
# –ü–†–û–¶–ï–°–° –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø
# ========================================

echo ""
echo "üîÑ –ù–ê–ß–ò–ù–ê–ï–ú –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï..."
echo "=============================="

# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
TEMP_DIR=$(mktemp -d)
echo "üìÅ –í—Ä–µ–º–µ–Ω–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $TEMP_DIR"

# –ò–∑–≤–ª–µ–∫–∞–µ–º –∞—Ä—Ö–∏–≤
echo "üì¶ –ò–∑–≤–ª–µ–∫–∞–µ–º –∞—Ä—Ö–∏–≤..."
if tar -xzf "$BACKUP_FILE" -C "$TEMP_DIR"; then
  echo "‚úÖ –ê—Ä—Ö–∏–≤ —É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–µ—á–µ–Ω"
else
  echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ –∞—Ä—Ö–∏–≤–∞"
  rm -rf "$TEMP_DIR"
  exit 1
fi

# –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∞–π–ª—ã
echo ""
echo "üîÑ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –§–ê–ô–õ–û–í:"
echo "========================"

RESTORED_COUNT=0
FAILED_COUNT=0

# –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —Ñ–∞–π–ª–∞–º –≤ –∞—Ä—Ö–∏–≤–µ
tar -tzf "$BACKUP_FILE" | while read archived_file; do
  SOURCE_FILE="$TEMP_DIR/$archived_file"
  TARGET_FILE="/$archived_file"
  TARGET_DIR=$(dirname "$TARGET_FILE")
  
  if [ -f "$SOURCE_FILE" ]; then
    # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    mkdir -p "$TARGET_DIR"
    
    # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª
    if cp "$SOURCE_FILE" "$TARGET_FILE"; then
      echo "‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: $TARGET_FILE"
      
      # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
      case "$TARGET_FILE" in
        */voice-ai-assistant/*)
          chown deployer:deployer "$TARGET_FILE" 2>/dev/null
          ;;
        /etc/nginx/*)
          chown root:root "$TARGET_FILE"
          chmod 644 "$TARGET_FILE"
          ;;
        /etc/fail2ban/*)
          chown root:root "$TARGET_FILE"
          chmod 644 "$TARGET_FILE"
          ;;
      esac
      
      RESTORED_COUNT=$((RESTORED_COUNT + 1))
    else
      echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏: $TARGET_FILE"
      FAILED_COUNT=$((FAILED_COUNT + 1))
    fi
  else
    echo "‚ö†Ô∏è  –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∞—Ä—Ö–∏–≤–µ: $archived_file"
  fi
done

# –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
rm -rf "$TEMP_DIR"

# ========================================
# –§–ò–ù–ê–õ–ò–ó–ê–¶–ò–Ø
# ========================================

echo ""
echo "üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø:"
echo "============================"
echo "‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: $RESTORED_COUNT"
echo "‚ùå –û—à–∏–±–æ–∫: $FAILED_COUNT"

# –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É —Å–µ—Ä–≤–∏—Å–æ–≤
echo ""
echo "üîÑ –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø –ü–ï–†–ï–ó–ê–ü–£–°–¢–ò–¢–¨ –°–ï–†–í–ò–°–´:"
echo "======================================"
echo "   sudo nginx -t && sudo systemctl reload nginx"
echo "   cd $PROJECT_DIR && sudo -u deployer npm run docker:restart"
echo "   sudo systemctl restart fail2ban"

echo ""
echo "‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ: $(date)"

# ========================================
# –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï:
# ========================================
# 
# 1. –ó–∞–ø—É—Å–∫: sudo ./restore_config.sh
# 2. –í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π –±—ç–∫–∞–ø –∏–∑ —Å–ø–∏—Å–∫–∞
# 3. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
# 4. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å—ã —Å–æ–≥–ª–∞—Å–Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º
# 
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –±—ç–∫–∞–ø–∞:
# echo "yes" | sudo ./restore_config.sh
# ======================================== 