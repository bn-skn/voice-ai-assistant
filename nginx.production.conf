# üöÄ PRODUCTION NGINX –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –î–õ–Ø VOICE AI ASSISTANT
# –û—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º –æ–ø—ã—Ç–µ –¥–µ–ø–ª–æ—è –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è WebSocket/Realtime API

# ========================================
# –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –î–õ–Ø HTTP (–ü–û–†–¢ 80)
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ HTTPS
# ========================================
server {
    listen 80;
    server_name YOUR_DOMAIN.COM;
    
    # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤–µ—Å—å HTTP —Ç—Ä–∞—Ñ–∏–∫ –Ω–∞ HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# ========================================
# –û–°–ù–û–í–ù–ê–Ø –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –î–õ–Ø HTTPS (–ü–û–†–¢ 443)
# ========================================
server {
    listen 443 ssl;
    server_name YOUR_DOMAIN.COM;
    
    # ===== SSL –°–ï–†–¢–ò–§–ò–ö–ê–¢–´ (Let's Encrypt) =====
    ssl_certificate /etc/letsencrypt/live/YOUR_DOMAIN.COM/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/YOUR_DOMAIN.COM/privkey.pem;
    
    # –í–∫–ª—é—á–∞–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ SSL –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    
    # ===== –ó–ê–ì–û–õ–û–í–ö–ò –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò =====
    # HSTS –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ HTTPS
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    
    # –ë–∞–∑–æ–≤—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "origin-when-cross-origin" always;
    
    # –°–∫—Ä—ã–≤–∞–µ–º –≤–µ—Ä—Å–∏—é Nginx
    server_tokens off;
    
    # ===== –ö–≠–®–ò–†–û–í–ê–ù–ò–ï –°–¢–ê–¢–ò–ß–ï–°–ö–ò–• –§–ê–ô–õ–û–í =====
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Cache-Status "STATIC";
        access_log off;
        
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # ===== –û–°–ù–û–í–ù–û–ô –ü–†–û–ö–°–ò –î–õ–Ø VOICE AI ASSISTANT =====
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # ===== –ö–†–ò–¢–ò–ß–ù–û: WebSocket –ò REALTIME API –ù–ê–°–¢–†–û–ô–ö–ò =====
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # –û—Ç–∫–ª—é—á–∞–µ–º –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—é –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
        proxy_buffering off;
        proxy_cache off;
        proxy_request_buffering off;
        
        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç—ã –¥–ª—è –¥–ª–∏—Ç–µ–ª—å–Ω—ã—Ö WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
        proxy_read_timeout 86400s;    # 24 —á–∞—Å–∞
        proxy_send_timeout 86400s;    # 24 —á–∞—Å–∞
        proxy_connect_timeout 10s;    # –ë—ã—Å—Ç—Ä–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        
        # –û—Ç–∫–ª—é—á–∞–µ–º gzip –¥–ª—è WebSocket (—Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–≥–æ location)
        gzip off;
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        add_header X-Proxy-Cache "BYPASS" always;
    }
    
    # ===== –°–ü–ï–¶–ò–ê–õ–¨–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê –î–õ–Ø API =====
    location /api/ {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # API —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 60s;
        proxy_send_timeout 60s;
        proxy_connect_timeout 5s;
        
        # –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è CORS (–µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è)
        add_header X-API-Version "1.0" always;
    }
    
    # ===== –û–ë–©–ò–ï –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–ò =====
    # –í–∫–ª—é—á–∞–µ–º gzip —Å–∂–∞—Ç–∏–µ –¥–ª—è HTML/JSON/CSS/JS (–Ω–æ –Ω–µ –¥–ª—è WebSocket)
    gzip on;
    gzip_vary on;
    gzip_min_length 1000;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;
    
    # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞ (–∑–∞—â–∏—Ç–∞ –æ—Ç DoS)
    client_max_body_size 10M;
    
    # –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    if ($request_method !~ ^(GET|POST|HEAD|OPTIONS|PUT|DELETE)$) {
        return 405;
    }
    
    # –ë–ª–æ–∫–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø –∫ —Å–∫—Ä—ã—Ç—ã–º —Ñ–∞–π–ª–∞–º
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # –ë–ª–æ–∫–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø –∫ backup —Ñ–∞–π–ª–∞–º
    location ~ ~$ {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# ========================================
# –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò
# ========================================

# –õ–∏–º–∏—Ç—ã –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç DDoS
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=general:10m rate=50r/s;

# –ü—Ä–∏–º–µ–Ω—è–µ–º –ª–∏–º–∏—Ç—ã
server {
    # ... (–æ—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤—ã—à–µ) ...
    
    location /api/ {
        limit_req zone=api burst=20 nodelay;
        # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ API ...
    }
    
    location / {
        limit_req zone=general burst=100 nodelay;
        # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ...
    }
}

# ========================================
# –ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –£–°–¢–ê–ù–û–í–ö–ï:
# ========================================
# 
# 1. –ó–∞–º–µ–Ω–∏—Ç–µ YOUR_DOMAIN.COM –Ω–∞ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π –¥–æ–º–µ–Ω
# 2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª: sudo cp nginx.production.conf /etc/nginx/sites-available/YOUR_DOMAIN.COM
# 3. –°–æ–∑–¥–∞–π—Ç–µ symlink: sudo ln -s /etc/nginx/sites-available/YOUR_DOMAIN.COM /etc/nginx/sites-enabled/
# 4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é: sudo nginx -t
# 5. –ü–æ–ª—É—á–∏—Ç–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç: sudo certbot --nginx -d YOUR_DOMAIN.COM
# 6. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Nginx: sudo systemctl reload nginx
#
# –í–ê–ñ–ù–û: Certbot –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç –ø—É—Ç–∏ –∫ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ!
# ======================================== 